<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ofertar - Producto 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>

    <link rel="icon" type="image/x-icon" th:href="@{/img/favicon.ico}" />

    <!-- Boostrap core css -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- custom style -->
    <link rel="stylesheet" th:href="@{/css/categorias.css}"/>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: userHeader}"></div>

<main class="container my-5">
    <div class="row g-4">

        <!-- Imagen del producto -->
        <div class="col-md-6">
             <div class="ratio ratio-4x3">
                  <div id="galeriaSubasta" class="carousel slide" data-bs-ride="carousel">
                      <div class="carousel-inner">

                          <div class="carousel-item active">
                              <img class="d-block w-75"
                                   th:src="@{/imagen/{subastaID}/{orden}(subastaID=${subastaDet.id}, orden=1)}"
                                   alt="Imagen 1">
                          </div>

                          <div class="carousel-item">
                              <img class="d-block w-75"
                                   th:src="@{/imagen/{subastaID}/{orden}(subastaID=${subastaDet.id}, orden=2)}"
                                   alt="Imagen 2">
                          </div>

                          <div class="carousel-item">
                              <img class="d-block w-75"
                                   th:src="@{/imagen/{subastaID}/{orden}(subastaID=${subastaDet.id}, orden=3)}"
                                   alt="Imagen 3">
                          </div>

                      </div>

                      <button class="carousel-control-prev" type="button"
                              data-bs-target="#galeriaSubasta" data-bs-slide="prev">
                          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Anterior</span>
                      </button>

                      <button class="carousel-control-next" type="button"
                              data-bs-target="#galeriaSubasta" data-bs-slide="next">
                          <span class="carousel-control-next-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Siguiente</span>
                      </button>
                  </div>
             </div>
          </div>

           <!-- Información y formulario -->
        <div class="col-md-6">
            <div class="card p-3">

                <h3 ><span th:text="${subastaDet.titulo}">-</span> </h3>
                <p>ID: <span th:text="${subastaDet.id}"></span></p>
                <p>Descripcion: <span th:text="${subastaDet.descripcion}"></span></p>
                <p>Precio inicial $ <span th:text="${subastaDet.precioInicial}"></span></p>


                <form th:action="@{/ofertar/guardar}" th:object="${oferta}" method="post">
                    <!-- idSubasta para el @RequestParam Long idSubasta -->
                    <input type="hidden" name="idSubasta" id="idSubasta" th:value="${subastaDet.id}"/>

                    <div class="mb-3">
                        <small>Monto Actual de la subasta: $
                            <span th:text="${subastaDet.precioActual != null ? subastaDet.precioActual : subastaDet.precioInicial}" id="montoActual"> </span></small>
                    </div>

                    <div class="mb-3">
                        <small>Tiempo restante: <span id='tiempoSubasta'></span> </small>
                    </div>

                    <div class="mb-3">
                        <label for="montoOfertado" class="form-label">Monto a ofertar</label>

                        <input type="number" th:field="*{montoOfertado}" id="montoOfertado" class="form-control" required />
                    </div>



                    <button type="submit" class="btn btn-primary w-100">Ofertar</button>

                    <div th:if="${error}" class="alert alert-danger mt-3" th:text="${error}"></div>
                    <div th:if="${mensaje}" class="alert alert-success mt-3" th:text="${mensaje}"></div>
                </form>



                <!-- Mensaje de confirmación -->
                <div th:if="${mensaje != null}" class="alert alert-success mt-3" th:text="${mensaje}"></div>
            </div>
        </div>

        <!-- Lista de últimas ofertas -->
        <div class="col-12">
            <div class="card p-3">
                <h4>Últimas ofertas</h4>
                <!--<ol>
                    <li th:each="ofertaItem : ${ultimasOfertas}"
                        th:text="${ofertaItem.ofertadorID.nombre + ' $' + ofertaItem.montoOfertado}"></li>
                </ol>-->
                <ol id="listaOfertas">

                </ol>
            </div>
        </div>

    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.bundle.min.js}"></script>
<!--<script type="module" th:src="@{js/oferta.js}"></script>
    Error: WARN  [qtp1656194780-19] o.s.web.servlet.PageNotFound - No mapping for GET /spring/ofertar/js/oferta.js
    TODO: arreglar el link al archivo oferta.js
-->
<script>
    const inputImporte = document.querySelector("#montoOfertado");
    const inputMontoActual = document.querySelector("#montoActual");
    const valorIdSubasta = document.querySelector("#idSubasta");
    const valorTiempoSubasta = document.querySelector("#tiempoSubasta");
    const tableListaOfertas = document.querySelector("#listaOfertas");

    const importeMinimo = 1;
    const intervalActualizarOferta = 5000; //5 segundos
    const intervalActualizarTimer = 1000; //1 segundo

    const temp = new Date();
    const finSubasta = new Date(temp);

    finSubasta.setDate(temp.getDate() + 1);

    inputImporte.value = Number(inputMontoActual.textContent) + importeMinimo;

    setInterval(callOfertas, intervalActualizarOferta);
    setInterval(temporizador, intervalActualizarTimer);

    function callOfertas(){
        let xhr = new XMLHttpRequest();
        let url = 'jsonOfertas/' + valorIdSubasta.value;
        xhr.open("GET",url, true);

        xhr.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                //console.log(this.responseText);
                let response = this.responseText;
                if(response.length != 0){
                    checkListaOfertas(JSON.parse(response));
                }
            }
        }

        xhr.send();
    }

    function checkListaOfertas(payload){
        let listaOfertas = payload.listaOfertas[0];
        if(tableListaOfertas.children.length == 0 && listaOfertas.length == 0 ){
            crearListaVacia();
        }
        if(tableListaOfertas.children.length == 0 && listaOfertas.length != 0){
            crearListaOfertas(listaOfertas);
        }
        if(tableListaOfertas.children.length != 0 && listaOfertas.length != 0){
            let idUltimaOfertaCall  = Number(listaOfertas[listaOfertas.length-1][0]);
            let idUltimaOfertaTabla = Number(tableListaOfertas.childNodes[0].id);
            if(idUltimaOfertaCall != idUltimaOfertaTabla){
                crearListaOfertas(listaOfertas);
            }
        }
    }

    function crearListaVacia(){
        const mensajeSinOfertas = "Esta subasta no tiene ofertas. Se el primero!";
        tableListaOfertas.innerHTML = '';
        let nodeSinOfertas = document.createElement('b');
        nodeSinOfertas.innerText = mensajeSinOfertas;
        tableListaOfertas.appendChild(nodeSinOfertas);
    }

    function crearListaOfertas(listaOfertas){
        tableListaOfertas.innerHTML = '';
        for(let i = 1; i <= listaOfertas.length; i++){
            let nodeOferta = document.createElement('li');
            let stringFechaOferta = listaOfertas[listaOfertas.length-i][1][0] + "-" + listaOfertas[listaOfertas.length-i][1][1] + "-" + listaOfertas[listaOfertas.length-i][1][2] + " "
                                  + listaOfertas[listaOfertas.length-i][1][3] + ":" + listaOfertas[listaOfertas.length-i][1][4] + ":" + listaOfertas[listaOfertas.length-i][1][5];
            let fechaOferta = new Date(stringFechaOferta);
            nodeOferta.setAttribute('id',listaOfertas[listaOfertas.length-i][0]);
            let texto = fechaOferta.getDate().toString().padStart(2,0)      + "/" +
                        fechaOferta.getMonth().toString().padStart(2,0)     + "/" +
                        fechaOferta.getFullYear().toString()                + " " +
                        fechaOferta.getHours().toString().padStart(2,0)     + ":" +
                        fechaOferta.getMinutes().toString().padStart(2,0)   + ":" +
                        fechaOferta.getSeconds().toString().padStart(2,0)   + " - " +
                        listaOfertas[listaOfertas.length-i][4]              + " " +
                        listaOfertas[listaOfertas.length-i][5]              + " - $ " +
                        listaOfertas[listaOfertas.length-i][2].toFixed(2);
            nodeOferta.innerText = texto;
            tableListaOfertas.appendChild(nodeOferta);
        }
    }

    function temporizador(){
        let ahora       = new Date().getTime();
        let diferencia  = finSubasta - ahora;

        let subastaHor = Math.floor( ( diferencia % (1000 * 60 * 60 * 24) )  / (1000 * 60 * 60) );
        let subastaMin = Math.floor( ( diferencia % (1000 * 60 * 60) )  / (1000 * 60) );
        let subastaSeg = Math.floor( ( diferencia % (1000 * 60) )  / (1000) );

        valorTiempoSubasta.textContent = subastaHor + "Hrs " + subastaMin + "Min " + subastaSeg + "Seg";
        if(diferencia < 0){
            valorTiempoSubasta.textContent = "FINALIZADO";
        }
    }
</script>
</body>
</html>
